<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tremor Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tremor Blog Atom Feed"><title data-react-helmet="true">To async or Not to async | Tremor</title><meta data-react-helmet="true" property="og:title" content="To async or Not to async | Tremor"><meta data-react-helmet="true" name="description" content="Moving from threads to async tasks."><meta data-react-helmet="true" property="og:description" content="Moving from threads to async tasks."><meta data-react-helmet="true" property="og:url" content="https://www.tremor.rs//blog/2020/08/06/to-async-or-not-to-async"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:image" content="https://www.tremor.rs//img/async.png"><meta data-react-helmet="true" name="twitter:image" content="https://www.tremor.rs//img/async.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/docs/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://www.tremor.rs//blog/2020/08/06/to-async-or-not-to-async"><link data-react-helmet="true" rel="alternate" href="https://www.tremor.rs//blog/2020/08/06/to-async-or-not-to-async" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.tremor.rs//blog/2020/08/06/to-async-or-not-to-async" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.772104c2.css">
<link rel="preload" href="/assets/js/runtime~main.c2c4df80.js" as="script">
<link rel="preload" href="/assets/js/main.d838971a.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.tremor.rs/" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/img/tremor-logo.png" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/tremor-logo.png" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link" href="/getting-started/about/">About Us</a><a class="navbar__item navbar__link" href="/docs/index">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/quick-start">Usage Guide</a><a class="navbar__item navbar__link" href="/api/0">API</a><a class="navbar__item navbar__link" href="/rfc/index">RFCs</a><a class="navbar__item navbar__link" href="/community/community">Community</a><a class="navbar__item navbar__link" href="/community/governance">Governance</a><a class="navbar__item navbar__link" href="/faqs">FAQs</a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/docs/index">0.11</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/index">Next</a></li><li><a class="dropdown__link" href="/docs/index">0.11</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub">GitHub</a><div class="searchWrapper_3rmH"><div class="dsla-search-wrapper"><div class="dsla-search-field"></div></div></div><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a href="https://www.tremor.rs/" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/img/tremor-logo.png" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/tremor-logo.png" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/getting-started/about/">About Us</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/index">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/quick-start">Usage Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/api/0">API</a></li><li class="menu__list-item"><a class="menu__link" href="/rfc/index">RFCs</a></li><li class="menu__list-item"><a class="menu__link" href="/community/community">Community</a></li><li class="menu__list-item"><a class="menu__link" href="/community/governance">Governance</a></li><li class="menu__list-item"><a class="menu__link" href="/faqs">FAQs</a></li><li class="menu__list-item"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link" aria-label="GitHub">GitHub</a></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/index">Next</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/index">0.11</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/07/06/Blog-Rohit-Property-Based-Testing">Property Based Testing of Tremor Script</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/LFX-Blog-Nupur">Support for the Syslog Protocol</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/29/T17-LFX-Blog-Jigyasa-gcloud">Google Cloud Storage and Pub/Sub Connectors</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2020/10/16/v09-release">Releasing Tremor v0.9!</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/blog/2020/08/06/to-async-or-not-to-async">To async or Not to async</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="margin-bottom--sm blogPostTitle_GeHD">To async or Not to async</h1><div class="margin-vert--md"><time datetime="2020-08-06T00:00:00.000Z" class="blogPostDate_fNvV">August 6, 2020 Â· 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/60009416?s=200&amp;v=4" alt="The Tremor Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a>The Tremor Team</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p>With the upcoming Tremor release, 0.9.0, we&#x27;re moving from threads as a basis for ramps and pipelines to async tasks.</p><p>Let&#x27;s talk about why this is significant, what is changing, and how the architecture is changing.</p><p>Note that this is not a comprehensive treatise on threads or async tasks.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="the-tremor-that-was-threads"></a>The Tremor That Was (threads)<a class="hash-link" href="#the-tremor-that-was-threads" title="Direct link to heading">#</a></h2><p>Threads are a basic building block of programs that run multiple pieces of code concurrently.
The operating system is responsible for coordinating across competing resource demands.</p><p>The OS can preempt, pause, and resume threads. We can leverage infinite or tight loops without the risk of completely blocking the system. These guarantees make concurrent code more accessible, with tools like<code>crossbeam-channels</code> to build upon.</p><p>Threads work especially well in use cases where the system and logical concurrency models are well aligned; or, we can map application threads to logical cores on the system being used. Each thread can happily work away on its part of the logic and pass the result on to the next. The one thread per core model is what tremor 0.8 and earlier used. We had a thread for the onramp, a thread for the pipeline, and a thread for the offramp. As the computational cost of decoding, processing, and encoding was often in the same ballpark, this worked exceptionally well. We managed to push up to 400MB/s of JSON through the system this way (including parsing, tremor-script logic, and serialization).</p><p>This design can degenerate badly if there are more ramps and pipelines than cores on the system in use. Throughput degrades rapidly (as in up to 2 orders of magnitude worse at 30:1 ratio). At the time of writing this, the deployment model was one pipeline/ramp group on a four-core system, so it worked well in practice.</p><p>However, this places a burden on operators having to think about concurrency and parallelism to tune tremor for optimal performance and capacity.</p><p>In SMP systems, we observe other undesireable effects: The moment two communicating threads don&#x27;t share the same underlying cache, performance plummets. This scenario exists when threads reside on two different CPUs or CCXs (<a href="https://blog.licenser.net/2020/01/multithreaded-rust-on-threadripper/" target="_blank" rel="noopener noreferrer">thank you AMD for making me learn so much about CPU caches</a>). As long as two communicating threads share the same cache, data shared between them can avoid trips to main memory and cache coherency protocol overheads. When two threads communicate across different caches, reads/writes may catastrophically collide and introduce overheads that drastically reduce overall performance.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="asyncfutures"></a>Async/Futures<a class="hash-link" href="#asyncfutures" title="Direct link to heading">#</a></h2><p>Futures, and in rust <code>async/await</code> (short async from here on), work differently than threads. With threads, the operating system has ultimate control over which thread is scheduled to work when. With async we can more flexibly manage scheduling in application code. This has many advantages in systems software.</p><p>Instead of the operating system preempting a thread, tasks require coordination within the application. The advantage is that since we can control where we take a pause, we can provide soft guarantees that the thread of control yields to the task schedulers in a way that better fits the application. A good example is async-io, where we allow another task to work whenever we have to wait for some IO.</p><p>In Tremor, we use channels extensively to coordinate event flows. They connect sources, sinks, and pipelines. Every time a channel is empty or full, we have to wait for a event that fills or drains a now blocked channel: This is a good juncture to let other tasks get ahead with their work. In tremor, these opportunities are fairly common.</p><p>The cooperative model is not without issues: If we select the wrong time to let other tasks work, we can hurt performance or even break the system. Giving up control in the right moment is especially tricky since it is sometimes happening implicitly. A task that loops without yielding forever is an extreme example. In OS managed threads, the OS can preempt a thread of control, so this is a non-issue. In user-managed tasks, however, this is an issue that needs to be protected against.</p><p>In rust, calling <code>.await</code> is effectively, not a guarantee. We cannot know if an async function ever yields. We can ensure that we yield control via yield_now. However, this comes at a cost: namely, that we might yield in situations where it is not strictly necessary.</p><p>With regards to performance, tasks are typically cheaper from a context switching perspective, and we have finer grained control. On the other hand, we lose control over where a task runs, while we can pin threads to cores to schedule affinity on SMP systems, tasks may migrate across cores or runners move freely.</p><p>In Tremor, we have adopted the <code>smol</code> small and fast async runtime. When two tasks can run consecutively on the same executor, <code>smol</code> will schedule them in different executors. A significant improvement over the thread-based tremor runtime is that <code>smol</code> does not aggressively steal work from other schedulers if they are not overloaded. This avoids the runtime trashing CPU caches based on <a href="https://github.com/async-rs/async-std/issues/848" target="_blank" rel="noopener noreferrer">micro-benchmarking results</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="behavioural-improvements"></a>Behavioural Improvements<a class="hash-link" href="#behavioural-improvements" title="Direct link to heading">#</a></h2><p>In previous releases of Tremor, the runtime focused on situations where applications had a limited and bounded number of stable long-lived concurrent pipelines in each instance. While multiple running artefacts were supported, in practice, tremor was deployed on systems with up to 4 logical cores.</p><p>This works exceptionally well with plain old threads. Starting with v0.9, Tremor is expanding to support an arbitrary number of running artefacts in a typical running instance, with a different logical core topology than production deployments to date.</p><p>Deploying a higher number of pipelines per instance changes our needs of the underlying concurrency mechanisms considerably. The plain old threads design will no longer scale to meet these changing requirements and the move to task-based scheduling with executors favours emerging workloads whilst incurring a negligible overhead to classic tremor workloads.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="initial-results"></a>Initial Results<a class="hash-link" href="#initial-results" title="Direct link to heading">#</a></h2><p>Ab initio, the switch has some practical implications, mainly an improvement in performance.</p><p>In Tremor v0.8.0, colocating pipelines required careful capacity planning and tuning by experienced operators. In tremor v0.9.0, this constraint has been lifted and the capacity planning burden drastically simplified. Improvements in <code>smol</code> itself over the last few versions means that we have broken the 500MB/s throughput barrier for the first time with the new task-based runtime, which is quite a nice bonus.</p><p>Let&#x27;s end with some pretty graphs. After all, a picture says more than a thousand words.</p><p>As a short explanation, this uses the json-throughput benchmark we have developed for Tremor running with deployments of one onramp, one pipeline, and one offramp to 64 onramps, 64 pipelines, and one offramp.</p><p><img alt="3 core performance" src="/assets/images/async-3-cores-afcbd1a0052cfec4bd1e0810535a910c.png"></p><p><img alt="48 core performance" src="/assets/images/async-48-cores-cb4557c688e68d35251683aba21454f8.png"></p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/dev">dev</a><a class="margin-horiz--sm" href="/blog/tags/rust">rust</a></div></footer></article><div><a href="https://github.com/tremor-rs/tremor-new-website/tree/main/blog/2020-08-06-to-async-or-not-to-async.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2020/10/16/v09-release"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Releasing Tremor v0.9!</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2020/03/31/rust-and-tell"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Rust &amp; Tell Berlin- March 2020 Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-tremor-that-was-threads" class="table-of-contents__link">The Tremor That Was (threads)</a></li><li><a href="#asyncfutures" class="table-of-contents__link">Async/Futures</a></li><li><a href="#behavioural-improvements" class="table-of-contents__link">Behavioural Improvements</a></li><li><a href="#initial-results" class="table-of-contents__link">Initial Results</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/quick-start/">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/faqs/">FAQs</a></li><li class="footer__item"><a class="footer__link-item" href="/api/0">Tremor API</a></li><li class="footer__item"><a class="footer__link-item" href="/community/governance/CodeofConduct">Code of Conduct</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://chat.tremor.rs/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/TremorDEBS" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://github.com/tremor-rs/tremor-runtime/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item">Download</a></li><li class="footer__item"><a href="https://www.cncf.io/" target="_blank" rel="noreferrer noopener" aria-label="CNCF"><img src="cncf-color.svg" alt="CNCF"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></div><div class="footer__copyright">Copyright Â© 2021 Tremor</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c2c4df80.js"></script>
<script src="/assets/js/main.d838971a.js"></script>
</body>
</html>