<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tremor Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tremor Blog Atom Feed"><title data-react-helmet="true">Investigations | Tremor</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://www.tremor.rs//community/development/investigations"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-community-current"><meta data-react-helmet="true" property="og:title" content="Investigations | Tremor"><meta data-react-helmet="true" name="description" content="Tools"><meta data-react-helmet="true" property="og:description" content="Tools"><link data-react-helmet="true" rel="shortcut icon" href="/docs/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://www.tremor.rs//community/development/investigations"><link data-react-helmet="true" rel="alternate" href="https://www.tremor.rs//community/development/investigations" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.tremor.rs//community/development/investigations" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.374baa17.css">
<link rel="preload" href="/assets/js/runtime~main.aabbe2de.js" as="script">
<link rel="preload" href="/assets/js/main.50b4e5e0.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.tremor.rs/" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link" href="/community/getting-started/getting-started">Getting Started</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" href="/community/community">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/community/community">Overview</a></li><li><a href="https://chat.tremor.rs" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Chat<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a class="dropdown__link" href="/community/governance">Governance</a></li><li><a class="dropdown__link" href="/community/faqs">FAQs</a></li><li><a class="dropdown__link" href="/rfc/index">RFCs</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/index">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" href="/docs/index">0.11</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/index">Next</a></li><li><a class="dropdown__link" href="/docs/index">0.11</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://chat.tremor.rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-discord-link" aria-label="Community Chat"></a><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="dsla-search-wrapper"><div class="dsla-search-field"></div></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/community/community">Community</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Getting Started</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/community/governance">Governance</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Governance</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Development</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/community/development/benchmarking">Benchmarking</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">benchmarks</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/community/development/debugging">Debugging Tremor</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">internal</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/community/development/investigations">Investigations</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/community/development/profiling">Profiling Tremor</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/community/development/quick-start">Usage Guide</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/community/development/testing">Testing</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/community/faqs">FAQs</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/community/teams">Tremor Teams</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Investigations</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="tools"></a>Tools<a class="hash-link" href="#tools" title="Direct link to heading">#</a></h2><p>Tools for investigating issues in a production environment.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="logs--metrics-prod"></a>Logs &amp; Metrics (prod)<a class="hash-link" href="#logs--metrics-prod" title="Direct link to heading">#</a></h3><p>Logs and metrics are the first and most fundamental tool when starting to investigate an issue. While they do not provide a deep insight they allow correlating events from the system under investigation and it is dependants and dependencies.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="htop-prod"></a><code>htop</code> (prod)<a class="hash-link" href="#htop-prod" title="Direct link to heading">#</a></h3><p>Not really a debugging tool but a nice starting point to see values like memory consumption, CPU load both per process and per thread. Things to look out for are:</p><ul><li>Memory consumption</li><li>CPU load</li><li>Number of processes</li><li>System Load (<a href="http://www.brendangregg.com/blog/2017-08-08/linux-load-averages.html" target="_blank" rel="noopener noreferrer">careful this can be misleading</a>!)</li></ul><p>To a degree <code>top</code> can be used in its place if <code>htop</code> isn&#x27;t available.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="perf-prod-linux"></a><code>perf</code> (prod: Linux)<a class="hash-link" href="#perf-prod-linux" title="Direct link to heading">#</a></h3><p>Perf is a tool that is used to profile processes, it gives an overview over functions that CPU time is spend on. While it doesn&#x27;t give a full trace but it is quite handy in situations where we have a hot function to find where a program is spending it time.</p><p>It can be run to find where a program spends time:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">perf record -p </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pid</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># ctrl-c after a while to stop recording</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">perf report </span><span class="token comment" style="color:#999988;font-style:italic"># will pick up the data that record generated</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It can do <strong>a lot more</strong> than this. A full tutorial on perf can be found <a href="https://perf.wiki.kernel.org/index.php/Tutorial" target="_blank" rel="noopener noreferrer">here</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="netstat-prod"></a><code>netstat</code> (prod)<a class="hash-link" href="#netstat-prod" title="Direct link to heading">#</a></h3><p><code>netstat</code> can be helpful to investigate networking state of connections and identify connection issues. Again it can be limited in the scope of docker unless run inside of the container. Please look at the man pages (<a href="https://linux.die.net/man/8/netstat" target="_blank" rel="noopener noreferrer"><code>man netstat</code></a>) for details, <a href="https://linuxtechlab.com/learn-use-netstat-with-examples/" target="_blank" rel="noopener noreferrer">this tutorial</a> also covers the basics and useful commands.</p><p>It also allows to investigate routing tables which can be very handy for connection issues.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ping-prod"></a><code>ping</code> (prod)<a class="hash-link" href="#ping-prod" title="Direct link to heading">#</a></h3><p>This isn&#x27;t exciting but if network related issues are suspected &quot;can I ping this address&quot; can cover a lot of ground and is always worth to check.</p><p>This can also be used to investigate MTU</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="lldb--lldb-rust-prod"></a><code>lldb</code> / <code>lldb-rust</code> (prod)<a class="hash-link" href="#lldb--lldb-rust-prod" title="Direct link to heading">#</a></h3><p>Both <code>lldb</code> and for rust more specifically <code>lldb-rust</code> are debuggers. They can attach to a program and step through the application step by step. A good starting guide can be found <a href="https://lldb.llvm.org/use/map.html" target="_blank" rel="noopener noreferrer">here</a>. It needs to be said that using lldb should be done with care, it will stop the program and has the potential to crash or terminate it. So far running lldb against a docker contained often lead to the process hanging or crashing.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="valgrind-dev-linux"></a><code>valgrind</code> (dev: Linux)<a class="hash-link" href="#valgrind-dev-linux" title="Direct link to heading">#</a></h3><p><code>valgrind</code> is used to debug and analyze memory leaks. While originally developed for C/C++ it mostly works with rust code as well - however on OS X it has shown to crash code and as the time of writing this is not a usable tool. More information can be found in the <a href="http://www.valgrind.org/docs/manual/quick-start.html" target="_blank" rel="noopener noreferrer">quick start</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="dtrace-dev-os-x--windows--bsd"></a><code>dtrace</code> (dev: OS X / Windows / BSD)<a class="hash-link" href="#dtrace-dev-os-x--windows--bsd" title="Direct link to heading">#</a></h3><p><code>dtrace</code>is a tool that allows low impact introspection of running systems. It allows putting probes on specific points in either kernel or user land code and perform analytics on the results. It is a very powerful tool but it requires learning to use efficiently. The <a href="http://www.brendangregg.com/dtrace.html" target="_blank" rel="noopener noreferrer">dtrace toolkit</a> is a good starting point.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="instruments-dev-os-x"></a>Instruments (dev: OS X)<a class="hash-link" href="#instruments-dev-os-x" title="Direct link to heading">#</a></h3><p>OS X comes with a user interface around dtrace that abstracts a lot of the complication away and presents some of the core functionality in bite-sized portions that can be used without requiring to understand the whole functionality of dtrace. It is installed alongside with XCode.</p><p>Some of the more interesting profiling templates are:</p><ul><li>Leaks - for finding memory leaks</li><li>Time Profiler - for finding &#x27;hot&#x27; functions</li><li>System Usage (I/O) - for finding I/O bottle necks</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="strace-prod-linux"></a><code>strace</code> (prod: Linux)<a class="hash-link" href="#strace-prod-linux" title="Direct link to heading">#</a></h3><p><code>strace</code> is a tool that allows tracing sys calls in Linux, it can be helpful to determine what system calls do occur during an observed issue. For example this can rule in our out specific kernel calls such as IO, muteness, threading, networking and so on.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="websocat-prod-nay"></a><code>websocat</code> (prod: nay)<a class="hash-link" href="#websocat-prod-nay" title="Direct link to heading">#</a></h3><p><a href="https://github.com/vi/websocat" target="_blank" rel="noopener noreferrer"><code>websocat</code></a> is a WebSocket client that can be used to interact with trmeors WebSocket onramp and offramp for testing.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="methodology"></a>Methodology<a class="hash-link" href="#methodology" title="Direct link to heading">#</a></h2><p>There is no &#x27;one way&#x27; to investigate an issue as what you find during the process will guide the next steps. Having seen and investigated other problems will help as it gives you a set of heuristics to go &quot;oh I&#x27;ve seen this before last time it was X&quot; but it is not required.</p><p>However there are general methods that have shown to be efficient in trying to investigate an issue. The mot basic approach consists of three steps:</p><ol><li>Look at the current state, the indicators that have made the issue visible such as logs or <code>htop</code>.</li><li>Formulate a theory what caused the issue - ideally write it down along with the factors of what promoted you to form this theory.</li><li>Decide on what would prove your theory - this is where you decide what the next debugging step is, it should ideally either completely confirm, or rule out your theory, that however isn&#x27;t always possible.</li><li>If the steps decided on in step 3 fully confirm the issue you&#x27;re done. If they fully disprove the theory go back to step 1 with the new information. If you neither have prove or disprove for your theory return to 3 and re-formulate what is required to prove it.</li></ol><p>Especially initially it helps to document each step as you progress along with any changes you made. This helps to prevent double-checking the same theory but also serves as a good learning exercise.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Don&#x27;t be shy to re-visit a theory if you found new evidence for it that were not visible in the first attempt.</p></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>It is very helpful to talk to someone, formulating the thoughts in sentences and words often springs new ideas and a second perspective helps with.</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="logs"></a>Logs<a class="hash-link" href="#logs" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="out-of-memory-issue-01"></a>Out of memory &#x27;issue&#x27; 01<a class="hash-link" href="#out-of-memory-issue-01" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="initial-observationsource-metrics--logs"></a>Initial observation(source: Metrics &amp; logs)<a class="hash-link" href="#initial-observationsource-metrics--logs" title="Direct link to heading">#</a></h4><p>On one of the busier boxes the memory of the process kept growing until the system started swapping. This happened repeatedly, after restarting the process the memory would slowly grow again.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="1st-theory-a-memory-leak-in-tremor-script"></a>1st theory: a memory leak in tremor-script<a class="hash-link" href="#1st-theory-a-memory-leak-in-tremor-script" title="Direct link to heading">#</a></h4><p>Most of tremor was written in rust which makes it very hard to create memory leaks, however we integrated two pieces of C code: tremor script and librdkafka those two pipieceses could either directly or by interfacing with rust introduce memory leaks.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="disprove-of-1st-theory-oom"></a>disprove of 1st theory (oom)<a class="hash-link" href="#disprove-of-1st-theory-oom" title="Direct link to heading">#</a></h5><p>We ran tremor extensively using the Leak profiler of Instruments to see if it could spot a memory leak. Any amount of memory profiling we did would not show any unusual allocations and missing deallocations. That made the 1st theory unlikely. However this did show a lot of allocation happening inside librdkafka.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="2nd-theory-misconfigured-librdkafka-operations"></a>2nd theory: Misconfigured librdkafka operations<a class="hash-link" href="#2nd-theory-misconfigured-librdkafka-operations" title="Direct link to heading">#</a></h4><p>With the hint gained from the last investigation we looked at the configuration of the system. It showed that a number instances of Kafka onramps were used and the hosts it running on were under spaced regarding to what was communicated to us. Looking at the manual for librdkafka showed that by default each librdkafka instance would allocate up to 1GB of memory as a buffer. Running 4 instances at a 4GB of memory box with additional processes this would eventually lead to running out of memory.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="prove-of-2nd-theory"></a>prove of 2nd theory<a class="hash-link" href="#prove-of-2nd-theory" title="Direct link to heading">#</a></h5><p>Re-deploying tremor with the librdkafka settings set to only use 100MB of memory for buffers we saw the growth disappear after the expected 400MB proving our theory.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="infinite-loop-in-librdkafka"></a>Infinite loop in librdkafka<a class="hash-link" href="#infinite-loop-in-librdkafka" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="initial-observation-source-metrics--logs"></a>Initial observation (source: Metrics &amp; logs)<a class="hash-link" href="#initial-observation-source-metrics--logs" title="Direct link to heading">#</a></h4><p>On GCP a node jumped to 75% (100% on a single core) and stopped processing data. No Kafka partitions were assigned to that node until it was restarted.</p><p>This bug hunt carries some complications. We have not been able to replicate the bug outside of a production environment. The environment runs on an outdated Linux, has no internet access to download tools and does not have many of the usual debugging tools available. The bug is rare enough that it take between one and two weeks to reproduce it.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="1st-theory-network-problems-on-gcp"></a>1st theory: network problems on GCP<a class="hash-link" href="#1st-theory-network-problems-on-gcp" title="Direct link to heading">#</a></h4><p>Since this was first and only observed directly after the migration to GCP the initial theory was that networking issues on GCP cause this problem.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="disprove-of-1st-theory-lib-kafka"></a>disprove of 1st theory (lib kafka)<a class="hash-link" href="#disprove-of-1st-theory-lib-kafka" title="Direct link to heading">#</a></h5><p>To validate the theory we installed the same version of tremor on-premises - and in parallel to working installations and observed if the issue would surface outside of GCP. If it wouldn&#x27;t we could have reduced it to a GCP related issue.</p><p><strong>Result</strong>: After two weeks of on-prem load we were able to recreate the issue locally, this invalidated our 1st theory.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="2nd-theory-a-bug-in-our-kafka-onramp"></a>2nd theory: a bug in our Kafka onramp<a class="hash-link" href="#2nd-theory-a-bug-in-our-kafka-onramp" title="Direct link to heading">#</a></h4><p>Inspecting the code that run Kafka we identified a possible issue that we didn&#x27;t abort on a bad return value to force a reconnect as we suspected the librdkafak wrapper to handle these situations.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="disprove-of-2nd-theory"></a>disprove of 2nd theory<a class="hash-link" href="#disprove-of-2nd-theory" title="Direct link to heading">#</a></h5><p>We patched our Kafka onramp to explicitly handle this bad returns and provide logs in that case (as it should be rare). We updated to see if this would resolve the issue.</p><p><strong>Result</strong>: After a week the issue re-surfaced without the related logs printed.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="3rd-theory-incompatible-versions-of-librdkafka-and-kafka"></a>3rd theory: incompatible versions of librdkafka and Kafka<a class="hash-link" href="#3rd-theory-incompatible-versions-of-librdkafka-and-kafka" title="Direct link to heading">#</a></h4><p>During the update of tremor we also updated the version of librdkakfa - the Kafka version however remained quite old. We theorized that incompatibility of the newer librdkafka and the old Kafka could cause undefined behavior such as the busy loop.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="disprove-of-3rd-theory"></a>disprove of 3rd theory<a class="hash-link" href="#disprove-of-3rd-theory" title="Direct link to heading">#</a></h5><p>We prepared a build of tremor with the same version of librdkafka we have been using in the past and updated the boxes in question to see if the bug would re-produce.</p><p><strong>Result</strong>: After a week and a half the bug re-surfaced, making a version conflict between Kafka and librdkafka unlikely.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="4th-theory-unhandled-mutex-locks-in-librdkafka"></a>4th theory: unhandled mutex locks in librdkafka<a class="hash-link" href="#4th-theory-unhandled-mutex-locks-in-librdkafka" title="Direct link to heading">#</a></h4><p>Inspecting a broken process with <code>perf</code> we would observe heavy load in pthread related code and the function <code>rd_kafka_q_pop_serve</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  36.35%  poll          libpthread-2.17.so  [.] pthread_cond_timedwait@@GLIBC_2.3.2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  19.88%  poll          tremor-server       [.] cnd_timedwait</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  19.14%  poll          tremor-server       [.] rd_kafka_q_pop_serve</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  15.09%  poll          tremor-server       [.] cnd_timedwait_abs</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   8.37%  poll          tremor-server       [.] 0x000000000009fcc0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   0.27%  poll          [kernel.kallsyms]   [k] __do_softirq</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After inspecting <a href="https://github.com/edenhill/librdkafka/blob/v1.0.0/src/rdkafka_queue.c#L336" target="_blank" rel="noopener noreferrer">the code</a> we noticed that <a href="https://github.com/edenhill/librdkafka/blob/v1.0.0/src/rdkafka_queue.c#L346" target="_blank" rel="noopener noreferrer">the lock obtained</a> in the function did not check if the lock was successful. The <a href="https://github.com/edenhill/librdkafka/blob/v1.0.0/src/rdkafka_queue.c#L402-L407" target="_blank" rel="noopener noreferrer">else condition</a> in the function could lead to an infinite loop calling the function over and over again.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="disprove-of-4th-theory"></a>disprove of 4th theory<a class="hash-link" href="#disprove-of-4th-theory" title="Direct link to heading">#</a></h5><p>We isolated the hot thread using <code>stop</code> - looking for the tremor thread that was using 100% CPU. We then traced system calls using <code>strace</code>. If librdkafka would attempt to fetch a mutex lock we should see related system calls in the <code>strace</code> output.</p><p>However observing the process for an hour didn&#x27;t show a single system call to be made on the hot thread - this ruled out any mutex/kernel-related code to be run in the hot loop.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="5th-theory-a-different-librdkafka-bug"></a>5th theory: a different librdkafka bug<a class="hash-link" href="#5th-theory-a-different-librdkafka-bug" title="Direct link to heading">#</a></h4><p>Inspecting the code and the <code>perf</code> output further we noticed that <code>cnd_timedwait_abs</code> was part of the <a href="https://github.com/edenhill/librdkafka/blob/v1.0.0/src/rdkafka_queue.c#L390" target="_blank" rel="noopener noreferrer">last condition</a> in a <code>while (1)</code> loop. It is reasonable to assume that if we spend time in <code>cnd_timedwait_abs</code> that we hit that part of the loop - if this call would fail the loop would re-run possibly creating an infinite loop.</p><p>In addition we found a related <a href="https://github.com/edenhill/librdkafka/issues/2208" target="_blank" rel="noopener noreferrer">kafka issue</a> that pointed to this particular location.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="proving-5th-theory"></a>proving 5th theory<a class="hash-link" href="#proving-5th-theory" title="Direct link to heading">#</a></h5><p>We deployed half the nodes with a version of tremor that the newest version of librdkafka (1.0.0) that includes a fix for the issue mentioned above while. We expect the patched nodes to keep stable and the unpatched nodes to eventually fail with the bug.</p><p>This never happened again.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="udp-gelf-messages-issue"></a>UDP GELF messages issue<a class="hash-link" href="#udp-gelf-messages-issue" title="Direct link to heading">#</a></h3><p>Issues:</p><ul><li>Undocumented and nonstandard conform use of Decompress after chunking, these messages were discarded, this was falsely attributed to tremor</li><li>Setup was spanning the WAN using local Logstas and WAN connected Tremor causing MTU issues that was not documented and falsely attributed to tremor</li><li>Using a nonstandard conform GELF header for &#x27;uncompressed&#x27; caused those datapoints to be discarded, this was falsely attributed to tremor</li><li>the UDP buffer on the Tremor and logstash hosts were configured differently causing the tremor host to have significantly less buffer causing some messages to be discarded in the OS UDP stack, this was falsely attributed to tremor</li><li>A tool called udp_replay was used to copy data from a logstash host to a tremor host, this tool truncated the UDP payload, this payload could no longer be decompressed making this packages fail, this was falsely attributed to tremor</li><li>Some clients send a empty tailing message with a bad segment index (n+1) causing error messages to appear in the logs, this is valid behavior but were flagged as a &#x27;bug&#x27; in tremor because logstash does silently drop those.</li><li>Some clients reuse the sequence number - this can lead to bad messages when UDP packages interleave, tremor reports those incidents and will likely be flagged as buggy because of it.</li><li>MIO&#x27;s UDP with edge-poll stops receiving data <a href="https://github.com/tokio-rs/mio/issues/1076" target="_blank" rel="noopener noreferrer">ticket</a> we switched to level poll which solves this.</li><li>PCAP files seem to include lots of invalid gelfs when replaying</li><li>When replaying the pacap the tool shows the following error.
thread &#x27;main&#x27; panicked at &#x27;called <code>Result::unwrap()</code> on an <code>Err</code> value: Error(WrongField(&quot;PacketHeader.incl_len (288) &gt; PacketHeader.orig_len (272)&quot;), State { next_error: None, backtrace: None })&#x27;, src/libcore/result.rs:999:5</li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/community/development/internal/transform"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Match to Functional</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/community/development/profiling"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Profiling Tremor Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tools" class="table-of-contents__link">Tools</a><ul><li><a href="#logs--metrics-prod" class="table-of-contents__link">Logs &amp; Metrics (prod)</a></li><li><a href="#htop-prod" class="table-of-contents__link"><code>htop</code> (prod)</a></li><li><a href="#perf-prod-linux" class="table-of-contents__link"><code>perf</code> (prod: Linux)</a></li><li><a href="#netstat-prod" class="table-of-contents__link"><code>netstat</code> (prod)</a></li><li><a href="#ping-prod" class="table-of-contents__link"><code>ping</code> (prod)</a></li><li><a href="#lldb--lldb-rust-prod" class="table-of-contents__link"><code>lldb</code> / <code>lldb-rust</code> (prod)</a></li><li><a href="#valgrind-dev-linux" class="table-of-contents__link"><code>valgrind</code> (dev: Linux)</a></li><li><a href="#dtrace-dev-os-x--windows--bsd" class="table-of-contents__link"><code>dtrace</code> (dev: OS X / Windows / BSD)</a></li><li><a href="#instruments-dev-os-x" class="table-of-contents__link">Instruments (dev: OS X)</a></li><li><a href="#strace-prod-linux" class="table-of-contents__link"><code>strace</code> (prod: Linux)</a></li><li><a href="#websocat-prod-nay" class="table-of-contents__link"><code>websocat</code> (prod: nay)</a></li></ul></li><li><a href="#methodology" class="table-of-contents__link">Methodology</a></li><li><a href="#logs" class="table-of-contents__link">Logs</a><ul><li><a href="#out-of-memory-issue-01" class="table-of-contents__link">Out of memory &#39;issue&#39; 01</a></li><li><a href="#infinite-loop-in-librdkafka" class="table-of-contents__link">Infinite loop in librdkafka</a></li><li><a href="#udp-gelf-messages-issue" class="table-of-contents__link">UDP GELF messages issue</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/quick-start/">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/faqs/">FAQs</a></li><li class="footer__item"><a class="footer__link-item" href="/api/0">Tremor API</a></li><li class="footer__item"><a class="footer__link-item" href="/community/governance/CodeofConduct">Code of Conduct</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://chat.tremor.rs/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/TremorDEBS" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/tremor-rs/tremor-runtime/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Download<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.cncf.io/" target="_blank" rel="noreferrer noopener" aria-label="CNCF"><img src="/img/cncf-color.svg" alt="CNCF" style="width: 200px;"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></div><div class="footer__copyright">Copyright Â© 2021 Tremor</div></div></div></footer></div>
<script src="/assets/js/runtime~main.aabbe2de.js"></script>
<script src="/assets/js/main.50b4e5e0.js"></script>
</body>
</html>