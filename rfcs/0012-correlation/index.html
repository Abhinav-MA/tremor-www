<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tremor Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tremor Blog Atom Feed"><title data-react-helmet="true">Tremor</title><meta data-react-helmet="true" property="og:title" content="Tremor"><meta data-react-helmet="true" property="og:url" content="https://www.tremor.rs//rfcs/0012-correlation"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/docs/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://www.tremor.rs//rfcs/0012-correlation"><link data-react-helmet="true" rel="alternate" href="https://www.tremor.rs//rfcs/0012-correlation" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.tremor.rs//rfcs/0012-correlation" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.64b546b3.css">
<link rel="preload" href="/assets/js/runtime~main.e7948ec0.js" as="script">
<link rel="preload" href="/assets/js/main.c55a2c90.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://tremor-rs.github.io/tremor-new-website/" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/img/tremor-logo.png" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/tremor-logo.png" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link" href="/getting-started/about/">About Us</a><a class="navbar__item navbar__link" href="/docs/index">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/quick-start">Usage Guide</a><a class="navbar__item navbar__link" href="/api/0">API</a><a class="navbar__item navbar__link" href="/rfcs/rfcs">RFCs</a><a class="navbar__item navbar__link" href="/community/community">Community</a><a class="navbar__item navbar__link" href="/governance">Governance</a><a class="navbar__item navbar__link" href="/faqs">FAQs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub">GitHub</a><div class="searchWrapper_3rmH"><div class="dsla-search-wrapper"><div class="dsla-search-field"></div></div></div><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a href="https://tremor-rs.github.io/tremor-new-website/" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/img/tremor-logo.png" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/tremor-logo.png" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/getting-started/about/">About Us</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/index">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/quick-start">Usage Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/api/0">API</a></li><li class="menu__list-item"><a class="menu__link" href="/rfcs/rfcs">RFCs</a></li><li class="menu__list-item"><a class="menu__link" href="/community/community">Community</a></li><li class="menu__list-item"><a class="menu__link" href="/governance">Governance</a></li><li class="menu__list-item"><a class="menu__link" href="/faqs">FAQs</a></li><li class="menu__list-item"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link" aria-label="GitHub">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper mdx-wrapper mdx-page"><main><div class="container container--fluid"><div class="margin-vert--lg padding-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><div class="container"><ul><li>Feature Name: <code>correlation_linked_transport</code></li><li>Start Date: 2021-03-12</li><li>Tremor Issue: <a href="https://github.com/tremor-rs/tremor-runtime/issues/0000" target="_blank" rel="noopener noreferrer">tremor-rs/tremor-runtime#0000</a></li><li>RFC PR: <a href="https://github.com/tremor-rs/tremor-rfcs/pull/0000" target="_blank" rel="noopener noreferrer">tremor-rs/tremor-rfcs#0000</a></li></ul><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="correlation"></a>Correlation<a class="hash-link" href="#correlation" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>Linked Transports enable integrating request-response-based communications with Tremor event-streams. Events coming from pipelines can be turned into requests and responses are turned into events, and sent on to other pipelines. Nonetheless, we currently can&#x27;t correlate them, that is, have request event data present in the context of the response event handling. This RFC is suggesting new means for convenient correlating of events, i.e. the <code>$correlation</code> metadata key.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="motivation"></a>Motivation<a class="hash-link" href="#motivation" title="Direct link to heading">#</a></h2><p>When we introduced <a href="/rfcs/0003-linked-transports/">Linked Transport</a>, we enabled request-response communication patterns with the outside world, like, HTTP or some Websocket protocols. Right now, request and response handling need to either be done in two different pipelines or in the same and be dispatched within the trickle/tremor-script logic. If any part of the request event needs to be around for response handling, the only option is to handle both in 1 pipeline and use the <code>state</code> mechanism to store and retrieve the request event data upon response handling.</p><p>We are currently adding some correlation data e.g. for the <code>elastic</code> offramp, where we store the whole origin <code>event_id</code>, <code>origin_uri</code> and the <code>payload</code> of the document indexed. Or, the <code>rest</code> offramp, where we include the HTTP request metadata into the response event. Those are in no means complete, in that, we can only correlate metadata that is also being sent to as the event itself (HTTP headers, elastic document payload). We want the correlation mechanism to be more flexible, and to not affect the actual event payload or outgoing protocol unit. Correlation should be an internal mechanism to your Tremor application logic.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="guide-level-explanation"></a>Guide-level Explanation<a class="hash-link" href="#guide-level-explanation" title="Direct link to heading">#</a></h2><p>Every Linked Transport onramp or offramp will for every incoming event take the <code>Value</code> at the metadata key <code>$correlation</code>, if any, and inject it into the response event metadata under the same key.</p><p>This way, users can pass correlation data from request to response without the need to manipulate the event payload, and thus, the application data to be sent out. Also, we only need to keep as much correlation data around as we have in-flight events, and most of all, we don&#x27;t require users to write complex and error-prone correlation logic in tremor-script, which will make code bases grow, possibly beyond reasonable maintainability.</p><p>Usage example using the <code>rest</code> offramp:</p><p>Here, we have the request handling pipeline, that moves some event field into the <code>$correlation</code> metadata field:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly trickle"><div tabindex="0" class="prism-code language-trickle codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># request handling</span></div><div class="token-line" style="color:#393A34"><span class="token plain">define script extract_correlation_id</span></div><div class="token-line" style="color:#393A34"><span class="token plain">script</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    # extract application key and put it into correlation</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let $correlation = $request.headers[&quot;X-Application-Key&quot;] ;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    event</span></div><div class="token-line" style="color:#393A34"><span class="token plain">end;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">select event from in into extract_correlation_id;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">select event from extract_correlation_id/out into out;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">select event from extract_correlation_id/err into err;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>This is the response handling pipeline which uses the <code>$correlation</code> metadata field in further event processing:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly trickle"><div tabindex="0" class="prism-code language-trickle codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># response handling</span></div><div class="token-line" style="color:#393A34"><span class="token plain">define script correlation</span></div><div class="token-line" style="color:#393A34"><span class="token plain">script</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    # preparation for sending this response further down the road via another rest offramp</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let $request.headers[&quot;X-Application-Key&quot;] = $correlation;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let $request.endpoint = &quot;http://example.org/application&quot;;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    event</span></div><div class="token-line" style="color:#393A34"><span class="token plain">end;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">select event from in into correlation;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">select event from correlation/out into out;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">select event from correlation/err into err;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>For cases where the event payload should be unaffected:</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="reference-level-explanation"></a>Reference-level Explanation<a class="hash-link" href="#reference-level-explanation" title="Direct link to heading">#</a></h2><p>As for the implementation, every linked transport needs to be touched and needs to keep around the correlation <code>Value</code>s for each in-flight event, and inject it into the response event.</p><p>This also includes cleaning up the correlation state in case of errors of the external systems, in case of timeouts and the like, so that we ensure that we never grow beyond the bounds of the configured concurrency.</p><p>We need to take care that no offramp/onramp uses that field for its own metadata.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="drawbacks"></a>Drawbacks<a class="hash-link" href="#drawbacks" title="Direct link to heading">#</a></h2><p>The state we need to keep at the Linked Transport offramp/onramp will grow with the supported concurrency (in-flight requests).</p><p>Implementing this will further complicate the already quite complex Linked Transport implementations. Maybe we should consider implementing this as part of the <a href="https://github.com/tremor-rs/tremor-rfcs/pull/32" target="_blank" rel="noopener noreferrer">Connectors RFC</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="rationale-and-alternatives"></a>Rationale and Alternatives<a class="hash-link" href="#rationale-and-alternatives" title="Direct link to heading">#</a></h2><p>In the initial ideas for this RFC, we came up with a <code>correlate</code> operator for &quot;joining&quot; a number of events based on some expression, say, <code>$correlation</code>. This was equipped with a <code>timeout</code>, so that we take care to not keep too much state around, and put a limit to the correlation window.</p><p>I decided against coding this as an operator as it can be implemented with core language features of <code>tremor-query</code>, with a size-based tumbling window and a group_by:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">define tumbling window size_2</span></div><div class="token-line" style="color:#393A34"><span class="token plain">with</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  size = 2,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  eviction_period = 1000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">end;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">select aggr::win::collect_flattened(event) from in[size_2] group by $correlation into out;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To get exactly the same timeout behaviour the operator would have, we might need to tweak the current <code>eviction_period</code> handling logic, as it currently only gets rid of groups after <code>2 x eviction_period</code>. But as the operator can only live in 1 pipeline, we need to pass both events through the same pipeline anyways, and the above code is much more idiomatic and feels more native and less cumbersome.</p><p>This pattern for correlation will find its way into the docs.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="prior-art"></a>Prior Art<a class="hash-link" href="#prior-art" title="Direct link to heading">#</a></h1><p>Correlating events is a key mechanism for enabling event tracing, which is usually achieved by adding trace ids to events. This is how e.g. <a href="https://zipkin.io" target="_blank" rel="noopener noreferrer">Zipkin</a> tracing works. So, there is a whole ecosystem around enabling observability with proper tracing that relies on those ids being present, and being delivered and maintained across boundaries. While most applications will already include a trace id like this in the event payload, it might still be required to enable keeping those ids while accessing external services via a linked transport. So, this enables better tracing scenarios for Tremor.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="unresolved-questions"></a>Unresolved Questions<a class="hash-link" href="#unresolved-questions" title="Direct link to heading">#</a></h2><p>None.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="future-possibilities"></a>Future Possibilities<a class="hash-link" href="#future-possibilities" title="Direct link to heading">#</a></h2><p>One road to take this RFC idea down is to bake the correlation and event tracing mechanism even deeper into the runtime.
What we have now with the internal <code>EventId</code> is some form of limited tracing, in that, it tracks the minimum and maximum of event ids per source.
We could extend this to build causal tracing chains. This is necessary, as at places like a windowed select query, a <code>generic::batch</code> operator we emit new events, with a new id. They do keep track of the events that make up the current one, but we cannot properly trace every single event with this mechanism. Such a tracing chain would be usable for the correlation feature, if made accessible to user pipeline code.</p></div></div><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#summary" class="table-of-contents__link">Summary</a></li><li><a href="#motivation" class="table-of-contents__link">Motivation</a></li><li><a href="#guide-level-explanation" class="table-of-contents__link">Guide-level Explanation</a></li><li><a href="#reference-level-explanation" class="table-of-contents__link">Reference-level Explanation</a></li><li><a href="#drawbacks" class="table-of-contents__link">Drawbacks</a></li><li><a href="#rationale-and-alternatives" class="table-of-contents__link">Rationale and Alternatives</a></li><li><a href="#unresolved-questions" class="table-of-contents__link">Unresolved Questions</a></li><li><a href="#future-possibilities" class="table-of-contents__link">Future Possibilities</a></li></ul></div></div></div></div></div></main></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/quick-start/">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/faqs/">FAQs</a></li><li class="footer__item"><a class="footer__link-item" href="/api/">Tremor API</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/governance/CodeOfConduct/">Code of Conduct</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://chat.tremor.rs/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/TremorDEBS" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://github.com/tremor-rs/tremor-runtime/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item">Download</a></li><li class="footer__item"><a href="https://www.cncf.io/" target="_blank" rel="noreferrer noopener" aria-label="CNCF"><img src="cncf-color.svg" alt="CNCF"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></div><div class="footer__copyright">Copyright Â© 2021 Tremor</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e7948ec0.js"></script>
<script src="/assets/js/main.c55a2c90.js"></script>
</body>
</html>