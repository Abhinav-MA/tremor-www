<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/tremor-new-website/blog/rss.xml" title="Tremor Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tremor-new-website/blog/atom.xml" title="Tremor Blog Atom Feed"><title data-react-helmet="true">Ingesting documents from kafka into elastic | Tremor</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://tremor-rs.github.io//tremor-new-website/docs/Workshop/examples/kafka_elastic_correlation/README"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Ingesting documents from kafka into elastic | Tremor"><meta data-react-helmet="true" name="description" content="All the application code here is available from the docs git repository."><meta data-react-helmet="true" property="og:description" content="All the application code here is available from the docs git repository."><link data-react-helmet="true" rel="shortcut icon" href="/tremor-new-website/docs/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://tremor-rs.github.io//tremor-new-website/docs/Workshop/examples/kafka_elastic_correlation/README"><link data-react-helmet="true" rel="alternate" href="https://tremor-rs.github.io//tremor-new-website/docs/Workshop/examples/kafka_elastic_correlation/README" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://tremor-rs.github.io//tremor-new-website/docs/Workshop/examples/kafka_elastic_correlation/README" hreflang="x-default"><link rel="stylesheet" href="/tremor-new-website/assets/css/styles.533ef8b2.css">
<link rel="preload" href="/tremor-new-website/assets/js/runtime~main.fe995719.js" as="script">
<link rel="preload" href="/tremor-new-website/assets/js/main.45acc0d9.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://tremor-rs.github.io/tremor-new-website/" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/tremor-new-website/static/img/tremor-logo.png" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/tremor-new-website/static/img/tremor-logo.png" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link" href="/tremor-new-website/about/">About Us</a><a class="navbar__item navbar__link navbar__link--active" href="/tremor-new-website/docs/index">Docs</a><a class="navbar__item navbar__link" href="/tremor-new-website/blog">Blog</a><a class="navbar__item navbar__link" href="/tremor-new-website/quick-start">Usage Guide</a><a class="navbar__item navbar__link" href="/tremor-new-website/api">API</a><a class="navbar__item navbar__link" href="/tremor-new-website/rfcs/rfcs">RFCs</a><a class="navbar__item navbar__link" href="/tremor-new-website/community">Community</a><a class="navbar__item navbar__link" href="/tremor-new-website/governance">Governance</a><a class="navbar__item navbar__link" href="/tremor-new-website/faqs">FAQs</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" href="/tremor-new-website/docs/Artefacts/codecs">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tremor-new-website/docs/Workshop/examples/kafka_elastic_correlation/README">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tremor-new-website/docs/">All versions</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_3vod"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>en</span></span></a><ul class="dropdown__menu"><li><a href="/tremor-new-website/docs/Workshop/examples/kafka_elastic_correlation/README" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">en</a></li></ul></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Artefacts</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/tremor-new-website/docs/ConstraintsLimitations">Constraints and Limitations</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Development</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/tremor-new-website/docs/FeatureComparison">Feature Comparison</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/tremor-new-website/docs/Glossary">Glossary</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Governance</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Operations</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/tremor-new-website/docs/QA">1 What should we use as a community collaboration environment?</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Workshop</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/tremor-new-website/docs/Workshop/README">Tremor Workshop</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">examples</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">passthrough</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">filter</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">transform</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">validate</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">logstash</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">influx</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">postgres_timescaledb</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">grafana</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">syslog_udp</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">syslog_udp_dns</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">transient_gd</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">persistent_gd</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">roundrobin</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">kafka_gd</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">servers_lt_http</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">servers_lt_ws</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">proxies_lt_http</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">proxies_lt_ws</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">bridges_lt_http_ws</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">reverse_proxy_load_balancing</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">quota_service</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">configurator</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">polling_alerts</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">kafka_elastic_correlation</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/tremor-new-website/docs/Workshop/examples/kafka_elastic_correlation/README">Ingesting documents from kafka into elastic</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">otel_passthrough</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">otel_zipkin</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">otel_jaeger</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">otel_prometheus</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">otel_elastic_apm</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/tremor-new-website/docs/api">api</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/tremor-new-website/docs/benchmarking">Benchmarking</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/tremor-new-website/docs/history">History</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/tremor-new-website/docs/index">Home</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">internal</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/tremor-new-website/docs/overview">Architecture Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">policies</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">tremor-script</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Ingesting documents from kafka into elastic</h1></header><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>All the application code here is available from the docs <a href="https://github.com/tremor-rs/tremor-www-docs/tree/main/docs/Workshop/examples/39_kafka_elastic_correlation" target="_blank" rel="noopener noreferrer">git repository</a>.</p></div></div><p>This example tries to show how to use tremor as the orchestrator for ingesting documents coming from kafka into elasticsearch and notify the upstream system of success or failure of the ingest operation for every single document.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="environment"></a>Environment<a class="hash-link" href="#environment" title="Direct link to heading">#</a></h2><p>In this walkthrough we explore how to make use of <em>Linked Transports</em>, <em>Guaranteed Delivery</em> and <em>Correlation</em> features of tremor.</p><p>In the <code>tremor_in</code> directory we have set up a tremor instance that acts as our data source for this workshop. It is not our main focus, but lets look at it, so we understand our source data.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="data-source"></a>Data source<a class="hash-link" href="#data-source" title="Direct link to heading">#</a></h3><p>The tremor instance used for feeding data into our main system contains of a <code>metronome</code> onramp which will emit an event every second. The connected pipeline will enrich those events with some metadata destined for the kafka offramp it is connected to.
Based on random choice it will change the event format to some incompatible format. This is done so we can trigger errors at elasticsearch later on.</p><p>The script responsible for creating the events is the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">define script add_meta</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  use tremor::system;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  use std::random;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # we add a message id as kafka header,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # that we use later on for correlation and notifying purposes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let message_id = &quot;#{system::ingest_ns()}&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let $kafka = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;headers&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;message_id&quot;: message_id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;key&quot;: message_id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # trigger some errors due to invalid formats</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # ES auto creates an index schema for the first event it rerceives,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # some next event will have a differently typed payload for the field `might_be_invalid`</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  match random::bool() of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case true =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;event&quot;: event,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;might_be_invalid&quot;: [true, false]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;event&quot;: event,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;might_be_invalid&quot;: 2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here we switch the value of the <code>might_be_invalid</code> field, based on ramdomness.
We also create a <code>message_id</code> from the event ingest timestamp and put it into the kafka headers. We are going to need this <code>message_id</code> later on for reporting the ingestion success or failure.</p><p>The resulting event is then put to kafka into the <code>tremor</code> topic.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ingestion-from-kafka-to-elasticsearch"></a>Ingestion from Kafka to Elasticsearch<a class="hash-link" href="#ingestion-from-kafka-to-elasticsearch" title="Direct link to heading">#</a></h3><p>In our ingestion pipeline in the <code>tremor_out</code> directory, we have setup a kafka consumer consuming from the <code>tremor</code> topic. It is forwarding the messages to elasticsearch:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">define script add_correlation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  use tremor::origin;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  use tremor::system;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  use std::string;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # add correlation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let $correlation = match $kafka.headers of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case headers = %{ present message_id } =&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      headers[&quot;message_id&quot;]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default =&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      # stupid fallback, actually should never happen</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;#{ system::ingest_ns() }&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # add elastic metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let $elastic = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;_index&quot;: &quot;foo&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;_id&quot;: string::from_utf8_lossy($kafka[&quot;key&quot;])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # form the event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;event&quot;: event,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;some_data&quot;: [ origin::as_uri_string() ]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here we add metadata for elasticsearch, so it ends up in the right index, we use the kafka key as elastic document id.
We also extract a <code>message_id</code> from the kafka headers and put it in <code>$correlation</code>. This special metadata value will
be forwarded across linked transports, like elasticsearch.</p><p>Further down in the ingestion pipeline we batch events up into counts of 10 to be more efficient when sending stuff over to elastic.</p><p>The elasticsearch offramp will issue success and error events from its <code>out</code> and <code>err</code> ports respectively. One event per batched document or one error event if something went wrong with the overall request execution (e.g. elasticsearch is not reachable).</p><p>We handle those events in two different pipelines. Success events are handled in this one:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">define script correlate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # add kafka metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let $kafka = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;headers&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;message_id&quot;: $correlation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;key&quot;: $correlation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # build up the notify event for success</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;success&quot;: event.success,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;message_id&quot;: $correlation,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;payload&quot;: event.payload,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;elastic_metadata&quot;: $elastic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">create script correlate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from in into correlate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from correlate into out;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from correlate/err into err;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here we extract the <code>$correlation</code> metadata and put it into the event payload. The actual event is sent back to kafka into the topic: <code>ingest_notify</code>. The machinery outside of this tremor application can re-inject the message based on the reported status, if need be. For you to enjoy events flying by we also directed the events to stdout/stderr.</p><p>For handling errors we also get <code>$correlation</code> metadata and can forward it back to kafka:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># handle elastic response from failing document or failing bulk insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># so this might be scoped to a document or to a failing elastic bulk request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">define script error_notify</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # add kafka metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let $kafka = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;headers&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;message_id&quot;: $correlation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;key&quot;: $correlation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  match $ of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{ present elastic } =&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      # this is an error for an invalid event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      emit {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;success&quot;: false,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;message_id&quot;: $correlation,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;payload&quot;: event.payload,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;error&quot;: event.error,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;elastic_metadata&quot;: $elastic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } =&gt; &quot;out&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default =&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      # this is an error report regarding the bulk request to ES</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      # we know it is batched, so $correlation is an array</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      # we need to explode this event into 1 event per $correlation value,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      # so the reporting back to kafka has 1 kafka record per ingested document</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      emit event =&gt; &quot;explode&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">create script error_notify;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from in into error_notify;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from error_notify/out into out;</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># explode the event for each `$correlation` value</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;success&quot;: false,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;message_id&quot;: group[0],</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;payload&quot;: event.payload,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;error&quot;: event.error</span></span><span class="token-line" style="color:#393A34"><span class="token plain">} from error_notify/explode group by each($correlation) into out;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from error_notify/err into err;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here we distinguish between errors per document (e.g. invalid format for the given index) and errors scoped to the whole request execution (no <code>$elastic</code> metadata).
In the case of a request error, we have an array of all the batched <code>$correlation</code> values and need to &quot;explode&quot; the event into 1 per <code>$correlation</code> id, so we can correctly
report back to kafka 1 document at a time.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="trying-this-at-home"></a>Trying this at home<a class="hash-link" href="#trying-this-at-home" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker compose up</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Once everything is set up you will see logs like this in your console:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">tremor_out_1     | [ERR] {&quot;success&quot;:false,&quot;message_id&quot;:&quot;MTYyMDEzNjg1NDY2NzI5OTQwMA==&quot;,&quot;payload&quot;:{&quot;event&quot;:{&quot;event&quot;:{&quot;onramp&quot;:&quot;metronome&quot;,&quot;ingest_ns&quot;:1620136854667292300,&quot;id&quot;:601},&quot;might_be_invalid&quot;:2},&quot;some_data&quot;:[&quot;tremor-kafka://kafka:9092/tremor/0/601&quot;]},&quot;error&quot;:{&quot;caused_by&quot;:{&quot;reason&quot;:&quot;Current token (VALUE_NUMBER_INT) not of boolean type\n at [Source: (byte[])\&quot;POST /_bulk HTTP/1.1\r\ncontent-type: application/json\r\ncontent-length: 2216\r\nuser-agent: reqwest/0.9.24\r\naccept: */*\r\naccept-encoding: gzip\r\nhost: elasticsearch:9200\r\n\r\n{\&quot;index\&quot;:{\&quot;_index\&quot;:\&quot;foo\&quot;,\&quot;_id\&quot;:\&quot;1620136845697865700\&quot;}}\n{\&quot;event\&quot;:{\&quot;event\&quot;:{\&quot;onramp\&quot;:\&quot;metronome\&quot;,\&quot;ingest_ns\&quot;:1620136845697859400,\&quot;id\&quot;:592},\&quot;might_be_invalid\&quot;:[true,false]},\&quot;some_data\&quot;:[\&quot;tremor-kafka://kafka:9092/tremor/0/592\&quot;]}\n{\&quot;index\&quot;:{\&quot;_index\&quot;:\&quot;foo\&quot;,\&quot;_id\&quot;:\&quot;1620136846698130900\&quot;}}\n{\&quot;event\&quot;:{\&quot;event\&quot;:{\&quot;onramp\&quot;:\&quot;metronome\&quot;,\&quot;ingest_ns\&quot;\&quot;[truncated 1884 bytes]; line: 1, column: 103]&quot;,&quot;type&quot;:&quot;json_parse_exception&quot;},&quot;reason&quot;:&quot;failed to parse field [event.might_be_invalid] of type [boolean] in document with id &#x27;1620136854667299400&#x27;. Preview of field&#x27;s value: &#x27;2&#x27;&quot;,&quot;type&quot;:&quot;mapper_parsing_exception&quot;},&quot;elastic_metadata&quot;:{&quot;_id&quot;:&quot;1620136854667299400&quot;,&quot;_index&quot;:&quot;foo&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;id&quot;:&quot;1620136854667299400&quot;,&quot;index&quot;:&quot;foo&quot;,&quot;doc_type&quot;:&quot;_doc&quot;}}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">tremor_out_1     | [OK] {&quot;success&quot;:true,&quot;message_id&quot;:&quot;MTYyMDEzNjg1MjY2NjgxMzAwMA==&quot;,&quot;payload&quot;:{&quot;event&quot;:{&quot;event&quot;:{&quot;onramp&quot;:&quot;metronome&quot;,&quot;ingest_ns&quot;:1620136852666806400,&quot;id&quot;:599},&quot;might_be_invalid&quot;:[true,false]},&quot;some_data&quot;:[&quot;tremor-kafka://kafka:9092/tremor/0/599&quot;]},&quot;elastic_metadata&quot;:{&quot;_id&quot;:&quot;1620136852666813000&quot;,&quot;_index&quot;:&quot;foo&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;id&quot;:&quot;1620136852666813000&quot;,&quot;index&quot;:&quot;foo&quot;,&quot;doc_type&quot;:&quot;_doc&quot;,&quot;version&quot;:1}}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">tremor_out_1     | [OK] {&quot;success&quot;:true,&quot;message_id&quot;:&quot;MTYyMDEzNjg1MzY2NzA5NjAwMA==&quot;,&quot;payload&quot;:{&quot;event&quot;:{&quot;event&quot;:{&quot;onramp&quot;:&quot;metronome&quot;,&quot;ingest_ns&quot;:1620136853667088800,&quot;id&quot;:600},&quot;might_be_invalid&quot;:[true,false]},&quot;some_data&quot;:[&quot;tremor-kafka://kafka:9092/tremor/0/600&quot;]},&quot;elastic_metadata&quot;:{&quot;_id&quot;:&quot;1620136853667096000&quot;,&quot;_index&quot;:&quot;foo&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;id&quot;:&quot;1620136853667096000&quot;,&quot;index&quot;:&quot;foo&quot;,&quot;doc_type&quot;:&quot;_doc&quot;,&quot;version&quot;:1}}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here we see one error message and two successful messages. For the error message you can clearly recognize the cause: <code>Current token (VALUE_NUMBER_INT) not of boolean type</code>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/tremor-rs/tremor-new-website/tree/main/docs/Workshop/examples/39_kafka_elastic_correlation/README.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tremor-new-website/docs/Workshop/examples/polling_alerts/README"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Polling</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/tremor-new-website/docs/Workshop/examples/otel_passthrough/README"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CNCF OpenTelemetry Passthrough Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#environment" class="table-of-contents__link">Environment</a><ul><li><a href="#data-source" class="table-of-contents__link">Data source</a></li><li><a href="#ingestion-from-kafka-to-elasticsearch" class="table-of-contents__link">Ingestion from Kafka to Elasticsearch</a></li></ul></li><li><a href="#trying-this-at-home" class="table-of-contents__link">Trying this at home</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tremor-new-website/quick-start/">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/tremor-new-website/faqs/">FAQs</a></li><li class="footer__item"><a class="footer__link-item" href="/tremor-new-website/api/">Tremor API</a></li><li class="footer__item"><a class="footer__link-item" href="/tremor-new-website/docs/Governance/CodeOfConduct/">Code of Conduct</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://chat.tremor.rs/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/TremorDEBS" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/tremor-rs/tremor-runtime/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Download<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.cncf.io/" target="_blank" rel="noreferrer noopener" aria-label="CNCF"><img src="static/img/cncf-color-minimalism.png" alt="CNCF"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/tremor-new-website/static/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/tremor-new-website/static/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></div><div class="footer__copyright">Copyright Â© 2021 Tremor</div></div></div></footer></div>
<script src="/tremor-new-website/assets/js/runtime~main.fe995719.js"></script>
<script src="/tremor-new-website/assets/js/main.45acc0d9.js"></script>
</body>
</html>