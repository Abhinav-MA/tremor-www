<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tremor Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tremor Blog Atom Feed"><title data-react-helmet="true">Modularity | Tremor</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://www.tremor.rs//rfc/implemented/modularity"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-rfc-current"><meta data-react-helmet="true" property="og:title" content="Modularity | Tremor"><meta data-react-helmet="true" name="description" content="- Feature Name: rfc-0010-modularity"><meta data-react-helmet="true" property="og:description" content="- Feature Name: rfc-0010-modularity"><link data-react-helmet="true" rel="shortcut icon" href="/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://www.tremor.rs//rfc/implemented/modularity"><link data-react-helmet="true" rel="alternate" href="https://www.tremor.rs//rfc/implemented/modularity" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.tremor.rs//rfc/implemented/modularity" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.b987a0a0.css">
<link rel="preload" href="/assets/js/runtime~main.4611206c.js" as="script">
<link rel="preload" href="/assets/js/main.f58d42f6.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.tremor.rs/" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link" href="/community/getting-started/getting-started">Getting Started</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" href="/community/community">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/community/community">Overview</a></li><li><a href="https://chat.tremor.rs" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Chat<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a class="dropdown__link" href="/community/governance">Governance</a></li><li><a class="dropdown__link" href="/community/faqs">FAQs</a></li><li><a class="dropdown__link" href="/rfc/index">RFCs</a></li><li><a class="dropdown__link" href="/community/EventsAndMedia">Events and Media</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/index">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" href="/docs/index">0.11</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/index">Next</a></li><li><a class="dropdown__link" href="/docs/index">0.11</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://chat.tremor.rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-discord-link" aria-label="Community Chat"></a><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="dsla-search-wrapper"><div class="dsla-search-field"></div></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rfc/index">RFCs</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Accepted</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Implemented</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/implemented/remove-actix-from-tremor-runtime">Remove Actix</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/implemented/linked-transports">Linked Transports</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/implemented/circuit-breaker-mechanism">Circuit Breaker Mechanism</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/implemented/pipeline-optimizations">Pipeline Optimisations</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/implemented/onramp-postgres">Onramp Postgres</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rfc/implemented/modularity">Modularity</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/implemented/string-interpolation">String Interpolation</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/implemented/correlation">Correlation</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">RFC Process</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Modularity</h1></header><ul><li>Feature Name: rfc-0010-modularity</li><li>Start Date: 2020-04-02</li><li>Tremor Issue: <a href="https://github.com/tremor-rs/tremor-runtime/pull/174" target="_blank" rel="noopener noreferrer">tremor-rs/tremor-runtime#0174</a></li><li>RFC PR: <a href="https://github.com/tremor-rs/tremor-rfcs/pull/0021" target="_blank" rel="noopener noreferrer">tremor-rs/tremor-rfcs#0021</a></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>Provide mechanisms for sharing, reuse and composition of user-defined logic in Tremor.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="motivation"></a>Motivation<a class="hash-link" href="#motivation" title="Direct link to heading">#</a></h2><p>As user-defined logic deployed with Tremor script and query pipelines become more complex and larger (by significant lines of code), mechanisms that favour better composition, reuse and sharing of user-defined logic and queries are needed.</p><p>Currently, the unit of modularity and unit of deployment in Tremor are indivisible blobs of code- be they scripts or queries. This has worked very well to date, but as the complexity and size of solutions built with Tremor grows, this is no longer tenable in the long term.</p><p>Identified requirements:</p><ul><li><p>As Tremor has multiple DSLs, the building blocks for reusing units of
code from the file system should be common across DSLs.</p></li><li><p>For tremor-script, code should be modularisable through the
introduction of functions.</p></li><li><p>For tremor-query, code should be modularisable through modular
definitions and/or reusable sub-queries.</p></li><li><p>Modules should be nestable on the file system, and within DSLs with
a consistent means to reference units of code or values defined
within nested modules, regardless of their origin (within the same
unit of code, from some external module).</p></li><li><p>There should be a mechanism to load external libraries or packages
of code from well-known locations.</p></li><li><p>The module mechanism should be usable by multiple DSLs with minimal
effort and with the same basic behaviour and structure. However, this
RFC does not place constraints on any DSL specifics per se.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="guide-level-explanation"></a>Guide-level Explanation<a class="hash-link" href="#guide-level-explanation" title="Direct link to heading">#</a></h2><p>Elements of modular user-defined logic in the Tremor project.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="module-path"></a>Module Path<a class="hash-link" href="#module-path" title="Direct link to heading">#</a></h3><p>A module path is a set of URLs (normatively directories on a file system) that form the root of a set of related modules.</p><p>On Linux/Unix, module paths are provided via the TREMOR_PATH environment variable, and they are separated by &#x27;:&#x27; (colon). Paths that are not readable or that do not exist are ignored.</p><p>Example path:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">TREMOR_PATH</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/etc/tremor/lib:/opt/shared/framework/lib:/opt/myproject/mylib&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="modules"></a>Modules<a class="hash-link" href="#modules" title="Direct link to heading">#</a></h3><p>Modules in Tremor are the lowest unit of compilation available to developers to modularise Tremor logic across multiple logical namespaces. On the filesystem, modules are rooted at a base path and are nested with folders. Within a file nesting is via the mod clause.</p><p>In tremor-script, only the top-level module can capture events or or mutate state. Modules loaded via the module system are restricted to const, fn, and intrinsic expressions. By design constraint at this time, tremor-script is biased towards pure side-effect free functional programming.</p><p>In tremor-query, only the top-level module can create nodes in the active query pipeline graph. A module logically encapsulates a reusable sub-graph in a query pipeline. The definitions of windows, operators or scripts can be reused. Within embedded scripts, modules used in scripts are constrained to the rules for modules for tremor-script. In addition, tremor-script modules can be included in trickle files to expose their functions and constants for use in <code>select</code>, <code>group by</code>, <code>having</code> and <code>where</code>.</p><p>In both the tremor-script and tremor-query DSLs, modules can be defined physically on the file system. For example, given the following modular hierarchy configured on the module path:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  +-- foo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    +-- bar</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      +-- snot.tremor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    +-- baz</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      +-- badger.tremor</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>A modular tremor-script can refer to the constant values as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">use foo::bar::snot; # snot is a ref to &#x27;foo/bar/snot.tremor&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">use foo::baz::badger; # badger is a ref to &#x27;foo/bar/badger.tremor&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let c = &quot;{snot::snot}{badger::badger}&quot;; # fully qualified references</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">c</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The same module hierarchy can be created in a Tremor file directly as
follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">mod foo with</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  mod bar with</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const snot = &quot;beep&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  mod baz with</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const badger = &quot;boop&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let snot = foo::bar::snot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let badger = foo::baz::badger;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;{snot}-{badger}&quot;;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Modules can be loaded via the <code>use</code> clause which in turn loads a module from the physical file system via the module path.</p><p>Inline and externalised modules can be used separately or together, as appropriate.</p><p>Where there are existing references, a module can be aliased to avoid clashes in the local scope:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">use foo::bar as fleek;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;Hello {fleek::snot}&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Modules in Tremor query follow the same semantics and behaviour with respect to physical versus inline definition, aliasing to avoid naming scope clashes.</p><p>It is to be noted that inclusion via <code>use</code> will prevent circular inclusion as in
file <code>a.tremor</code> can use <code>b.tremor</code>, but at that point, <code>b.tremor</code> can no longer
use <code>a.tremor</code> as this would create a circle. This is a restriction of the current implementation, and may or may not be relaxed in the future.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="preprocessor"></a>Preprocessor<a class="hash-link" href="#preprocessor" title="Direct link to heading">#</a></h3><p>In order to support the module mechanism with minimal changes to the API and runtime, a preprocessor loads all externally referenced modules used in Tremor logic defined in tremor-script or tremor-query, and loads them inline into a preprocessed file.</p><p>It is an error to attempt to deploy a tremor-script or tremor-query file that uses the module mechanism as source. The API only accepts non-modular files for backward compatibility or preprocessed files. The latter constraint is to ensure that logic deployed into the runtime is always traceable to source loaded by a user. Tremor explicitly avoids possibilities of modular logic changing at runtime.</p><p>The preprocessor defends this guarantee on behalf of our users.</p><p>This PR introduces two preprocessor directives:</p><ol><li><p><code>#!line &lt;byte offset&gt; &lt;line&gt; &lt;column&gt; &lt;compilation unit&gt; &lt;filename&gt;</code></p><blockquote><p>This directive tells the preprocessor that it is
now in a logically different position of the file.</p><p>For each folder/directory that an included source traverses, a
module statement is injected into the consolidated source.</p><p>The #!line macro is a implementation detail mentioned here for the same
of completeness, and not meant to be used or relied on by end users. It
may, without prior warning, be removed in the future.</p></blockquote></li><li><p><code>#!config &lt;key&gt; = &lt;const-expr&gt;</code></p><blockquote><p>Pipeline-level configuration in trickle, this allows setting
compile time pipeline configuration such as <code>metrics_interval_s</code>.</p></blockquote></li></ol><p>Preprocessing our script from the module section produces a single consolidated source file as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">#!line 0 0 0 1 ./foo/bar/snot.tremor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">mod snot with</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#!line 0 0 0 1 ./foo/bar/snot.tremor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const snot = &quot;beep&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#!line 19 1 0 0 script.tremor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#!line 0 0 0 2 ./foo/baz/badger.tremor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">mod badger with</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#!line 0 0 0 2 ./foo/baz/badger.tremor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const badger = &quot;boop&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#!line 41 1 0 0 script.tremor</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let c = &quot;{snot::snot}{badger::badger}&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">emit c</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="functions"></a>Functions<a class="hash-link" href="#functions" title="Direct link to heading">#</a></h3><p>While constants in modules offer the ability to have reusable data, functions allow for reusable logic.</p><p>Functions are expression-based- so every function returns a data value. Functions cannot manipulate or mutate events, metadata or state. Side effecting operations to the data flow through a script such as the <code>emit</code> or <code>drop</code> keywords are also not allowed in functions.</p><p>Recursion, specifically tail recursion, is supported in functions but a maximum recursion depth (of currently 1024 by default) is imposed. The limit can be changed in tremor-server using the <code>--recursion-limit LIMIT</code> argument. As Tremor is primarily an event processing engine, there are no facilities for user-defined logic to loop or recurse infinitely. Recursion is indicated by the <code>recur</code> expression that gets passed data from the current iteration as arguments for the following invocation. Functions may access constants, but cannot access external mutable state.</p><p>Functions are limited to only call functions that were defined prior to themselves; this limits the risk of cyclic recursion between multiple functions and ensures that every call is guaranteed to terminate.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="functions-come-in-multiple-forms"></a>Functions Come in Multiple Forms:<a class="hash-link" href="#functions-come-in-multiple-forms" title="Direct link to heading">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="intrinsic-functions"></a>Intrinsic functions<a class="hash-link" href="#intrinsic-functions" title="Direct link to heading">#</a></h5><p>Intrinsic functions provide the signature of a builtin function. These are provided for documentation purposes and so that API documentation can be provided for builtin functions in the same way as user-defined functions.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">### The `test` module is used for writing tremor unit</span></span><span class="token-line" style="color:#393A34"><span class="token plain">### tests.</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">## Runs an assertion for a test, ensures that `expected` and</span></span><span class="token-line" style="color:#393A34"><span class="token plain">## `got` are the</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">## same. If not errors.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">##</span></span><span class="token-line" style="color:#393A34"><span class="token plain">## **WARNING**: Do not run assertions in production code!</span></span><span class="token-line" style="color:#393A34"><span class="token plain">##</span></span><span class="token-line" style="color:#393A34"><span class="token plain">## Returns an `bool`.</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">intrinsic fn assert(name, expected, got) as test::assert;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="ordinary-functions"></a>Ordinary Functions<a class="hash-link" href="#ordinary-functions" title="Direct link to heading">#</a></h5><p>Of the form <code>fn &lt;name&gt;([&lt;args&gt;][,...]) with</code> provide named arguments with
optional variable arguments through the ellipses <code>...</code> or varargs operator.
Varargs are stored in the <code>args</code> array.</p><p>The ordinary form does not support partial functions.</p><p>An ordinary function wrapping a call to a tail recursive fibonacci function:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">fn fib(n) with</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  fib_(0, 1, n)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fib(7); # Call locally defined function fib</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="matching-functions"></a>Matching Functions<a class="hash-link" href="#matching-functions" title="Direct link to heading">#</a></h5><p>Matching functions using <code>fn &lt;name&gt;(&lt;args&gt;) of</code> followed by case expressions, and an optional default statement that match.</p><p>The matching function form imposes a default case requirement so that unmatches cases have error handling defined. Unlike match expressions, the default case in user-defined functions must not (and can not) be omitted.</p><p>A contrived example showing math functions with value matching, extractor matching and function case guards:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">use std::type;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn snottify(s) of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  case (&quot;badger&quot;) =&gt; &quot;snot badger, hell yea!&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  case (\~ json||) =&gt; let s.snot = true, s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  case (s) when type::is_string(s) =&gt; &quot;snot {s}&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  default =&gt; &quot;snot caller, you can&#x27;t snottify that!&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="recursive-functions"></a>Recursive Functions<a class="hash-link" href="#recursive-functions" title="Direct link to heading">#</a></h5><p>Tail recursive functions follow the signature of the function over which recursion is being invoked and use a <code>recur(&lt;args&gt;)</code> call expression.</p><p>If the signature of a recursive call supports partial function semantics, then this is respected under tail recursion.</p><p>If the signature of a recursive call supports varargs semantics, then this is respected under tail recursion.</p><p>A tail-recursive implementation of fibonacci called by fib(n) above:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">fn fib_(a, b, n) of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  case (a, b, n) when n &gt; 0 =&gt; recur(b, a + b, n - 1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  default =&gt; a</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="limitations-and-constraints"></a>Limitations and Constraints:<a class="hash-link" href="#limitations-and-constraints" title="Direct link to heading">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="functions-can-only-be-defined-with-singular-arity"></a>Functions Can Only be Defined with Singular Arity<a class="hash-link" href="#functions-can-only-be-defined-with-singular-arity" title="Direct link to heading">#</a></h5><p>Functions currently can not be redefined with multiple arities. So, a function <code>foo(n)</code> precludes a second definition of a function called <code>foo</code> with two or more arguments. However the function <code>foo(n,...)</code> defines a function that can take one or more arguments. This constraint may be lifted in the future once usage and adoption favour enhancing functionality.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="higher-order-functions-are-not-supported"></a>Higher Order Functions are not Supported<a class="hash-link" href="#higher-order-functions-are-not-supported" title="Direct link to heading">#</a></h5><p>As the type system underpinning tremor-script and tremor-query does not support expression or function references, higher order functions are thus not supported at this time.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="hardcoded-recursion-depth"></a>Hardcoded Recursion Depth<a class="hash-link" href="#hardcoded-recursion-depth" title="Direct link to heading">#</a></h5><p>Although functions are tail-recursive and stack limits are not a functional concern, the Tremor event processing system is primarily designed for event streaming applications. A recursion depth is imposed to prevent functions from recursing indefinitely and blocking event streams from progressing.</p><p>This is a feature, not a constraint. But it is important to be aware of when developing well-behaved functions.</p><p>At this point in time, the maximum depth is 1024, and can not be changed without recompiling Tremor.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="tuple-patterns"></a>Tuple patterns<a class="hash-link" href="#tuple-patterns" title="Direct link to heading">#</a></h3><p>As a side effect of adding functions, this RFC introduces tuple patterns. Internally, they are used to implement Matching functions but are available for use in match statements as well.</p><p>Tuple patterns are written in the form of <code>%(&lt;pattern 1&gt;, &lt;pattern 2&gt;)</code> for
patterns with a fixed number of elements or <code>%(&lt;pattern 1&gt;, &lt;pattern 2&gt;, ...)</code>
with literal <code>...</code> for open patterns.</p><p>Tuple patterns with a fixed number of elements match arrays, with the same
number of elements, where each element matches the pattern in the same place. So
the first pattern must match the first element of the array, the second pattern
the second element and so on.</p><p>An open pattern matches an array that is at lest the same number of elements as
the pattern, but can have more, otherwise the rules are the same.</p><p>There is also a new pattern introduced to predicate patterns which is the &quot;I
don&#x27;t care&quot; pattern <code>_</code>, which will match every element on an array.</p><p>So:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tremor"><pre tabindex="0" class="prism-code language-tremor codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">let o = origin::as_uri_record();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">match o of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # matches for the path:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # &quot;/api/v1/get/&lt;something&gt;&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # &quot;/api/v1/get/&lt;something&gt;/snot&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # &quot;/api/v1/get/&lt;something&gt;/snot/badger&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # and so one</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  case %(&quot;api&quot;, &quot;v1&quot;, &quot;get&quot;, _, ...) =&gt; &quot;get request&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="reference-level-explanation"></a>Reference-level Explanation<a class="hash-link" href="#reference-level-explanation" title="Direct link to heading">#</a></h2><p>The module path, modules and <code>use</code> rule provide the language and runtime agnostic core facilities that allow queries in tremor-query and code in tremor-script to be namespaced logically via the <code>mod</code> syntax and physically on file systems.</p><p>A new lexical preprocessing phase parses out occurrences of <code>use</code> rules in scripts, queries and embedded scripts replacing them with preprocessing directives and the contents of referenced modules.</p><p>The parser in modular scripts and queries must now keep track of relative and absolute module scope. As support for both logical namespaces via the <code>mod</code> syntax and physical isolation through the file system and module path is supported, an external module effectively defines a module namespace. So, a source file <code>foo.trickle</code> at the root of the module path would ordinarily be used to include definitions into another query with a <code>use foo;</code> declaration at the head of the file.</p><p>Nested directories also form namespaces so <code>bar/baz/snot.trickle</code> would be declared for use as <code>use bar::baz::snot</code>. The same layout and rules apply for scripts so <code>bar/baz/snot.trickle</code> would be declared for use as <code>use bar::baz::snot</code>.</p><p>Where modules of the same base name in the physical file system such as &#x27;badger.tremor&#x27; and &#x27;badger.trickle&#x27; are present in the same module path, the behaviour of the runtime is currently undefined. The prototype implementation of modules in Tremor that accompanies this RFC gracefully handle the situation for embedded Tremor scripts within trickle query files.</p><p>As a convenience to developers, developer tools such as <code>tremor-tool</code>, <code>tremor-script</code> and <code>tremor-query</code> automatically included the current working directory as a mount point in the module path. If a <code>TREMOR_PATH</code> environment variable is set then it overrides any default behaviour.</p><p>In tremor-server, <code>TREMOR_PATH</code> is required to be set or no include path will be available. This is reflected in the Docker image.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="drawbacks"></a>Drawbacks<a class="hash-link" href="#drawbacks" title="Direct link to heading">#</a></h2><p>Modularising logic in Tremor increases complexity of the engine and runtime, however the relative increase in complexity is perceived as negligible given the value gained by developers by introducing the facility.</p><p>At this time, higher order functions are not supported as the Tremor-type system is constrained to JSON compatible value types and introducing module or function references would make the type system asymmetric with JSON. This is left for a future RFC.</p><p>At this time, the query language supports only modularising definitions of windows, operators or scripts. The creation of query language pipeline graph nodes or link of nodes in a graph is not supported in external modules.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="rationale-and-alternatives"></a>Rationale and Alternatives<a class="hash-link" href="#rationale-and-alternatives" title="Direct link to heading">#</a></h2><p>The design of the module mechanism and its application to tremor-script and tremor-query provide the highest degree of reuse whilst imposing the lowest runtime impact today and without closing off opportunities for evolving and improving the mechanisms in future.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="prior-art"></a>Prior art<a class="hash-link" href="#prior-art" title="Direct link to heading">#</a></h2><p>This RFC and it&#x27;s implementation draws inspiration from the C preprocessor as well as the application of <code>use</code> in Rust, and the functional pattern matching style from the Erlang programming language.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="unresolved-questions"></a>Unresolved Questions<a class="hash-link" href="#unresolved-questions" title="Direct link to heading">#</a></h2><p>None.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="future-possibilities"></a>Future Possibilities<a class="hash-link" href="#future-possibilities" title="Direct link to heading">#</a></h2><p>Currently var arg functions do not combine with either match or recursion or matching functions. This presents a good future opportunity for extending functions.</p><p>Another future possibility is to expand the capabilities of use in trickle to include full sub queries.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/rfc/implemented/onramp-postgres"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Onramp Postgres</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/rfc/implemented/string-interpolation"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">String Interpolation Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#summary" class="table-of-contents__link">Summary</a></li><li><a href="#motivation" class="table-of-contents__link">Motivation</a></li><li><a href="#guide-level-explanation" class="table-of-contents__link">Guide-level Explanation</a><ul><li><a href="#module-path" class="table-of-contents__link">Module Path</a></li><li><a href="#modules" class="table-of-contents__link">Modules</a></li><li><a href="#preprocessor" class="table-of-contents__link">Preprocessor</a></li><li><a href="#functions" class="table-of-contents__link">Functions</a></li><li><a href="#tuple-patterns" class="table-of-contents__link">Tuple patterns</a></li></ul></li><li><a href="#reference-level-explanation" class="table-of-contents__link">Reference-level Explanation</a></li><li><a href="#drawbacks" class="table-of-contents__link">Drawbacks</a></li><li><a href="#rationale-and-alternatives" class="table-of-contents__link">Rationale and Alternatives</a></li><li><a href="#prior-art" class="table-of-contents__link">Prior art</a></li><li><a href="#unresolved-questions" class="table-of-contents__link">Unresolved Questions</a></li><li><a href="#future-possibilities" class="table-of-contents__link">Future Possibilities</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/quick-start/">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/community/faqs">FAQs</a></li><li class="footer__item"><a class="footer__link-item" href="/api/0">Tremor API</a></li><li class="footer__item"><a class="footer__link-item" href="/community/governance/CodeofConduct">Code of Conduct</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://chat.tremor.rs/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/TremorDEBS" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/tremor-rs/tremor-runtime/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Download<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.cncf.io/" target="_blank" rel="noreferrer noopener" aria-label="CNCF"><img src="/img/cncf-color.svg" alt="CNCF" style="width: 200px;"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></div><div class="footer__copyright">Copyright Â© 2021 Tremor</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4611206c.js"></script>
<script src="/assets/js/main.f58d42f6.js"></script>
</body>
</html>