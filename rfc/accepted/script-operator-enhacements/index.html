<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tremor Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tremor Blog Atom Feed"><title data-react-helmet="true">script-operator-enhacements | Tremor</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://www.tremor.rs//rfc/accepted/script-operator-enhacements"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-rfc-current"><meta data-react-helmet="true" property="og:title" content="script-operator-enhacements | Tremor"><meta data-react-helmet="true" name="description" content="- Feature Name: script operator enhancements"><meta data-react-helmet="true" property="og:description" content="- Feature Name: script operator enhancements"><link data-react-helmet="true" rel="shortcut icon" href="/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://www.tremor.rs//rfc/accepted/script-operator-enhacements"><link data-react-helmet="true" rel="alternate" href="https://www.tremor.rs//rfc/accepted/script-operator-enhacements" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.tremor.rs//rfc/accepted/script-operator-enhacements" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.b987a0a0.css">
<link rel="preload" href="/assets/js/runtime~main.2257032c.js" as="script">
<link rel="preload" href="/assets/js/main.9509ee84.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.tremor.rs/" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link" href="/docs/next/getting-started/getting-started">Getting Started</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" href="/community/community">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/community/community">Overview</a></li><li><a href="https://chat.tremor.rs" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Chat<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a class="dropdown__link" href="/community/governance">Governance</a></li><li><a class="dropdown__link" href="/community/faqs">FAQs</a></li><li><a class="dropdown__link" href="/rfc/index">RFCs</a></li><li><a class="dropdown__link" href="/community/EventsAndMedia">Events and Media</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/index">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" href="/docs/index">0.11</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/getting-started/getting-started">Next</a></li><li><a class="dropdown__link" href="/docs/index">0.11</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://chat.tremor.rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-discord-link" aria-label="Community Chat"></a><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="dsla-search-wrapper"><div class="dsla-search-field"></div></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rfc/index">RFCs</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Accepted</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rfc/accepted/script-operator-enhacements">script-operator-enhacements</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/accepted/pipeline-state-mechanism">Pipeline State Mechanism</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/accepted/sliding-window-mechanism">Sliding Window Mechanism</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/accepted/plugin-development-kit">Plugin development Kit</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/accepted/ramp-interface">Ramp Interface</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Implemented</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">RFC Process</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>script-operator-enhacements</h1></header><ul><li>Feature Name: <code>script</code> operator enhancements</li><li>Start Date: 2021-04-28</li><li>Tremor Issue: <a href="https://github.com/tremor-rs/tremor-runtime/issues/960" target="_blank" rel="noopener noreferrer">tremor-rs/tremor-runtime#960</a> <a href="https://github.com/tremor-rs/tremor-runtime/issues/933" target="_blank" rel="noopener noreferrer">tremor-rs/tremor-runtime#933</a></li><li>RFC PR: <a href="https://github.com/tremor-rs/tremor-rfcs/pull/0000" target="_blank" rel="noopener noreferrer">tremor-rs/tremor-rfcs#0000</a></li></ul><header><h1>Summary</h1></header><p>This RFC aims to add quality of life improvements to the script operator. As it exists today, the operator works well for simple use-cases but-in light of the growing number of complex pipelines and the use of patterns like the configurator pattern it is cumbersome. When first implemented, <code>state</code> didn&#x27;t exist, and ports were not used. Those are the areas of improvement this RFC tackles.</p><p>The improvements focus around handling of state and tackle two common cases:</p><p>1) decupling the control plane logic (setting / modifying state) and the data plane logic (using state to make decisions)
2) seeding the state with a value</p><header><h1>Motivation</h1></header><p>To demonstrate we will give a motivating example if the reduction of complexity for a simplified algorithm for distributed loadbalancing:</p><p>The original code has to contend with not knowing what ports data comes in and having to verify the initalization of state on every event.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly trickle"><pre tabindex="0" class="prism-code language-trickle codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">define grouper::bucket operator bucketing;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">define script lb</span></span><span class="token-line" style="color:#393A34"><span class="token plain">with</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  rate = 0,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  peer = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;host&quot;: &quot;127.0.0.1&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;port&quot;: 4242</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  self = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;host&quot;: &quot;127.0.0.1&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;port&quot;: 4243</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # If the state isn&#x27;t intialized, do this now</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  match absent state.rate of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case true =&gt; let state = {&quot;quota&quot;: args.quota, &quot;rate&quot;: 1.0 }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default =&gt; null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  match event of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # we got a delta message in reply that tells us how to adjust our quota</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{ present delta } =&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      let state.quota = state.quota + event.delta</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # we got a compare message asking us to figure out the adjustment required</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # apply it, and send it over to the requester</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{ present cmp } =&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      let delta = state.quota * (state.rate - event.rate),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      let state.rate = state.rate - delta,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      let $udp = event.udp,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      emit {&quot;delta&quot;: delta} =&gt; &quot;udp&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{ present rate } =&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      let state.rate = event.rate,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      drop</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # we are asked to propage our rate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{ id == &quot;proagate&quot; } =&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      emit { &quot;quota&quot;: state.quota } =&gt; &quot;config&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Tick event for periodic checks</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{ id == &quot;tick&quot; } =&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      let $udp = args.peer,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      emit {&quot;cmp&quot;: state.quota, &quot;udp&quot;: args.self } =&gt; &quot;udp&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case _ =&gt; emit =&gt; &quot;dbg&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">define script rate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  match event of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{tags ~= %{node == &quot;bucketing&quot;, port == &quot;out&quot;, action == &quot;pass&quot;} } =&gt; let state.pass = event.fields.count</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{tags ~= %{node == &quot;bucketing&quot;, port == &quot;out&quot;, action == &quot;overflow&quot;} } =&gt; let state.overflow = event.fields.count</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case _ =&gt; drop</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  match state of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{ present pass, present overflow } when state.pass + state.overflow &gt; 0 =&gt; {&quot;rate&quot;: state.pass / (state.pass + state.overflow)}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case _ =&gt; drop</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">define script apply</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let rate = match state of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case null =&gt; let state = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case _ =&gt; null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  match event of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{ present quota } =&gt; let state = event.quota, drop</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case _ =&gt; null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let $class =  &quot;default&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let $rate = state</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">create operator bucketing;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">create script apply;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">create script rate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">create script lb;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># main data flow</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from in into apply;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from apply into bucketing;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from bucketing into out;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># rate updates from bucketing metrics</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from bucketing/metrics into rate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from rate into lb/rate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># rate updates from the load balancing logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from lb/config into apply/config;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># udp coms for the load balancer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from in/udp into lb/udp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from lb/udp into lb/out;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly trickle"><pre tabindex="0" class="prism-code language-trickle codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">define grouper::bucket operator bucketing;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">define script lb</span></span><span class="token-line" style="color:#393A34"><span class="token plain">with</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  rate = 0,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  peer = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;host&quot;: &quot;127.0.0.1&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;port&quot;: 4242</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  self = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;host&quot;: &quot;127.0.0.1&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;port&quot;: 4243</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">state</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  {&quot;quota&quot;: args.quota, &quot;rate&quot;: 1.0}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script from &quot;udp&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  match event of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{ present delta } =&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      let state.quota = state.quota + event.delta,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      drop</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # we got a compare message asking us to figure out the adjustment required</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # apply it, and send it over to the requester</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{ present cmp } =&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      let delta = state.quota * (state.rate - event.rate),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      let state.rate = state.rate - delta,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      let $udp = event.udp,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      emit {&quot;delta&quot;: delta} =&gt; &quot;udp&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># rate update event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script from &quot;rate&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let state.rate = event;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  drop</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># propagation tick to send current quota to new</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script from &quot;propagate&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  emit { &quot;quota&quot;: state.quota } =&gt; &quot;config&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script from &quot;tick&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let $udp = args.peer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  emit {&quot;cmp&quot;: state.quota, &quot;udp&quot;: args.self } =&gt; &quot;udp&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  emit =&gt; &quot;dbg&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">define script rate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">state</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  {}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  match event of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{tags ~= %{node == &quot;bucketing&quot;, port == &quot;out&quot;, action == &quot;pass&quot;} } =&gt; let state.pass = event.fields.count</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{tags ~= %{node == &quot;bucketing&quot;, port == &quot;out&quot;, action == &quot;overflow&quot;} } =&gt; let state.overflow = event.fields.count</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case _ =&gt; drop</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  match state of</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case %{ present pass, present overflow } when state.pass + state.overflow &gt; 0 =&gt; state.pass / (state.pass + state.overflow)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case _ =&gt; drop</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">define script apply</span></span><span class="token-line" style="color:#393A34"><span class="token plain">state  0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script for &quot;config&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let state = event;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  drop</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let $class =  &quot;default&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let $rate = state;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">create operator bucketing;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">create script apply;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">create script rate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">create script lb;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># main data flow</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from in into apply;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from apply into bucketing;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from bucketing into out;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># rate updates from bucketing metrics</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from bucketing/metrics into rate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from rate into lb/rate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># rate updates from the load balancing logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from lb/config into apply/config;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># udp coms for the load balancer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from in/udp into lb/udp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from lb/udp into lb/out;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># ticks</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from in/tick into lb/tick;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from in/propagate into lb/propagate;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>Guide-level explanation</h1></header><p>This introduces two new parts to the to the seelct statement.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="state"></a><code>state</code><a class="hash-link" href="#state" title="Direct link to heading">#</a></h2><p>The <code>state</code> section is introduced as an optional section to provide an initial state. One alternative would be calling it <code>init</code> however using that would introduce a new keyword and by that break backwards compatibility and reduce the number of possible idents.</p><p>The content of <code>state</code> would get executed as part of the initialisation and then set once before the script is executes for the first time.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="script-for-port"></a><code>script for &quot;&lt;port&gt;&quot;</code><a class="hash-link" href="#script-for-port" title="Direct link to heading">#</a></h2><p>The addition of <code>script for &quot;&lt;port&gt;&quot;</code> allows to define different script path for the different ports connected to the script operator.</p><p>They would share a <code>state</code> but not share local variables or constants. This is an extremely handy pattern in scenarios like the configurator pattern where one set of messages is used to adjust state and the other set of messages being processas as events.</p><p>In other words, it allows seperating control and data plane of a script.</p><header><h1>Reference-level explanation</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="state-1"></a><code>state</code><a class="hash-link" href="#state-1" title="Direct link to heading">#</a></h2><p>This will get executed at initiation time to take <code>args</code> into acount. Then never be executed again
in a running pipeline.</p><p>The <code>state</code> section will be optional.</p><p>This means the addition is backwards compatible.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="script-for-port-1"></a><code>script for &quot;&lt;port&gt;&quot;</code><a class="hash-link" href="#script-for-port-1" title="Direct link to heading">#</a></h2><p>This would basically be a loopup table for <code>port</code> -&gt; <code>script</code> with an additional &quot;catch all&quot; <code>script</code>
that gets executed if no port is specified.</p><p>All <code>script for</code> sections will be optional, <code>script</code> itself however madatory.</p><p>This means the addition is backwards compatible.</p><header><h1>Drawbacks</h1></header><p>Drawbacks are addition of additional language constructs and introducing the usage of input ports for the first time which might add complexity for users.</p><p>On the other hand as both additions are optional thos complexity is hidden unless explicitly used.</p><header><h1>Rationale and alternatives</h1></header><p>One alternative to the <code>state</code> keyword could be replaced by <code>init</code> which might be more intuitive but would add another keyword and break backwards compatibility by that.</p><p>Alternatives for <code>script for</code> would be adding a <code>port</code> keyword to access the port or a <code>system::port()</code> function. The addition of the <code>port</code> keyword would introduce the same backwards compatibility issues as the <code>init</code> keywoard so is likely not a good idea. However adding the <code>system::port()</code> (or a differently named) funciton would be possible in addition without negative impact.</p><header><h1>Prior art</h1></header><p><code>init</code> or <code>state</code> pretty much has prior art in most of any language that uses constructors for data.</p><p>Since <code>select from &quot;&lt;port&gt;&quot;</code> is rather specific to the tremor runtime it isn&#x27;t inspired by any prior art.</p><header><h1>Unresolved questions</h1></header><p>None at this point.</p><header><h1>Future possibilities</h1></header><p>A <code>system::port()</code> (or equivalent) function would be a good addition.</p><p>Another possibility this opens is to allow analyzing different script path and their respective ports. that way we can make a more detailed cycle analysis on a script that has a control plane and a data plane that do not overlap.</p><p>For example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">define script control_and_data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script for &quot;control&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let state = sevent;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  drop</span></span><span class="token-line" style="color:#393A34"><span class="token plain">script for event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // do something with event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from  control_and_data/metrics to control_and_data/control;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">select event from in into out;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here we could determine that the &quot;control&quot; section never emits data, so no loop is created.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/rfc/index"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« RFCs</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/rfc/accepted/pipeline-state-mechanism"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Pipeline State Mechanism Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#state" class="table-of-contents__link"><code>state</code></a></li><li><a href="#script-for-port" class="table-of-contents__link"><code>script for &quot;&lt;port&gt;&quot;</code></a></li><li><a href="#state-1" class="table-of-contents__link"><code>state</code></a></li><li><a href="#script-for-port-1" class="table-of-contents__link"><code>script for &quot;&lt;port&gt;&quot;</code></a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/quick-start/">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/community/faqs">FAQs</a></li><li class="footer__item"><a class="footer__link-item" href="/api/0">Tremor API</a></li><li class="footer__item"><a class="footer__link-item" href="/community/governance/CodeofConduct">Code of Conduct</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://chat.tremor.rs/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/TremorDEBS" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/tremor-rs/tremor-runtime/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Download<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.cncf.io/" target="_blank" rel="noreferrer noopener" aria-label="CNCF"><img src="/img/cncf-color.svg" alt="CNCF" style="width: 200px;"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/favicon.ico" alt="Tremor Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></div><div class="footer__copyright">Copyright Â© 2021 Tremor</div></div></div></footer></div>
<script src="/assets/js/runtime~main.2257032c.js"></script>
<script src="/assets/js/main.9509ee84.js"></script>
</body>
</html>